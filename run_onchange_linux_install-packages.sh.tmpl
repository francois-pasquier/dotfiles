#!/bin/bash

{{ if eq .chezmoi.os "linux" -}}
{{   if eq .chezmoi.osRelease.id "debian" "ubuntu" -}}
# Only run if we have apt-get
if command -v apt-get &>/dev/null; then
  echo "Detected Debian/Ubuntu system. Installing packages via apt..."

  # Update apt cache
  sudo apt-get update

printf "\nStarting apt packages installation...\n"
  {{ range .packages.linux.apt -}}
  sudo apt-get install -y {{ . | quote }}
  {{ end -}}

  echo "Apt packages installation complete."

  printf "\nRemoving unused packages...\n"
  sudo apt-get autoremove -y
else
  echo "apt-get not found, skipping apt package installation."
fi
{{   end -}}

if command -v snap &>/dev/null; then
  printf "\nStarting snaps installation...\n"
  {{ range .packages.linux.snaps -}}
  sudo snap install {{ . | quote }}
  {{ end -}}
  printf "\nSnaps installation complete\n"
fi

# Source nix if available
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

if command -v nix &>/dev/null; then
  printf "\nStarting Nix packages installation...\n"
  {{- range .packages.nix }}
  printf "Installing {{ . }}...\n"
  nix profile add 'nixpkgs#{{ . }}' || echo "Failed to install {{ . }}, skipping..."
  {{- end }}
  {{- range .packages.linux.nix }}
  printf "Installing {{ . }}...\n"
  nix profile add 'nixpkgs#{{ . }}' || echo "Failed to install {{ . }}, skipping..."
  {{- end }}
  printf "\nNix packages installation completed.\n"
else
  printf "\nNix not found, skipping Nix packages installation.\n"
fi

# Install Zed
curl -f https://zed.dev/install.sh | sh

{{ end -}}
